<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parreira Sistemas</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="core/styles/portal.css">
</head>

<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <span class="material-icons-round">hub</span>
            </div>
            <div class="logo-text">
                <h1>Parreira Sistemas</h1>
                <span>Enterprise Platform</span>
            </div>
        </div>
        <div class="user-info">
            <div class="user-name">
                <strong id="userName">Carregando...</strong>
                <span id="userRole">-</span>
            </div>
            <button class="btn-logout" onclick="logout()">
                <span class="material-icons-round">logout</span>
                Sair
            </button>
        </div>
    </header>

    <main class="main">
        <div class="welcome">
            <h2>Selecione um M√≥dulo</h2>
            <p>Escolha o m√≥dulo que deseja acessar</p>
        </div>

        <div class="modules-grid">
            <!-- Master -->
            <div class="module-card module-master disabled" onclick="openModule('master')">
                <div class="module-icon">
                    <span class="material-icons-round">admin_panel_settings</span>
                </div>
                <h3>Master Panel</h3>
                <p>Gest√£o de clientes, m√≥dulos e configura√ß√µes da plataforma.</p>
                <span class="module-status master">üëë Administrador</span>
            </div>

            <!-- ERP -->
            <!-- ERP -->
            <div class="module-card module-erp" onclick="openModule('erp')">
                <div class="module-icon">
                    <span class="material-icons-round">account_balance</span>
                </div>
                <h3>ERP</h3>
                <p>Gest√£o completa: Financeiro, Fiscal, CRM, Vendas, Cadastros.</p>
                <span class="module-status active">‚úÖ Dispon√≠vel</span>
            </div>

            <!-- Sales Force -->
            <div class="module-card module-sales disabled" onclick="openModule('sales-force')">
                <div class="module-icon">
                    <span class="material-icons-round">phone_android</span>
                </div>
                <h3>For√ßa de Vendas</h3>
                <p>App para vendedores externos com funcionamento offline.</p>
                <span class="module-status coming">üöß Em desenvolvimento</span>
            </div>

            <!-- WMS -->
            <div class="module-card module-wms" onclick="openModule('wms')">
                <div class="module-icon">
                    <span class="material-icons-round">warehouse</span>
                </div>
                <h3>WMS</h3>
                <p>Gest√£o de armaz√©m para +10.000 SKUs com rastreabilidade.</p>
                <span class="module-status active">‚úÖ Dispon√≠vel</span>
            </div>

            <!-- WMS Coletor -->
            <div class="module-card module-wms-coletor" onclick="openModule('wms-coletor')">
                <div class="module-icon" style="background: linear-gradient(135deg, #06b6d4 0%, #0e7490 100%);">
                    <span class="material-icons-round">phone_android</span>
                </div>
                <h3>WMS Coletor</h3>
                <p>App mobile para operadores de armaz√©m com scanner.</p>
                <span class="module-status active">‚úÖ Dispon√≠vel</span>
            </div>

            <!-- Dispatch -->
            <div class="module-card module-dispatch" onclick="openModule('dispatch')">
                <div class="module-icon">
                    <span class="material-icons-round">local_shipping</span>
                </div>
                <h3>Despacho Log√≠stico</h3>
                <p>Cota√ß√£o de frete, montagem de carga e romaneio.</p>
                <span class="module-status active">‚úÖ Dispon√≠vel</span>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2026 Parreira Sistemas. Desenvolvido com ‚ù§Ô∏è</p>
    </footer>

    <!-- Login Modal -->
    <style>
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 2.5rem;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-login:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
    </style>

    <div class="login-overlay" id="loginOverlay" style="display: none;">
        <div class="login-card">
            <div class="login-header">
                <div class="logo-icon" style="margin: 0 auto 1rem; width: 64px; height: 64px;">
                    <span class="material-icons-round" style="font-size: 32px;">hub</span>
                </div>
                <h2>Parreira Sistemas</h2>
                <p style="color: var(--text-secondary);">Fa√ßa login para continuar</p>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">ID da Empresa</label>
                    <input type="text" id="tenantId" class="form-input" placeholder="Ex: parreiralog" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Usu√°rio</label>
                    <input type="text" id="username" class="form-input" placeholder="Usu√°rio" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Senha</label>
                    <input type="password" id="password" class="form-input" placeholder="Senha" required>
                </div>

                <button type="submit" class="btn-login">ENTRAR</button>
            </form>
        </div>
    </div>

    <div class="version-badge" id="versionBadge">v3.4.0</div>

    <script>
        // Whitelist compartilhada de tenants permitidos (Hardcoded + Dynamic)
        // Registry: Tenants and Users (Shared LocalStorage)
        const storedTenants = JSON.parse(localStorage.getItem('platform_tenants_registry') || '[]');
        const storedUsers = JSON.parse(localStorage.getItem('platform_users_registry') || '[]');

        // Update Whitelist
        const dynamicIds = storedTenants.map(t => t.id);
        const ALLOWED_TENANTS = ['ltdistribuidora', 'centralpecas', 'parreira', ...dynamicIds];

        // MOCK USERS for Fallback (if registry is empty/broken)
        // Isso garante que o admin (voc√™) consiga entrar mesmo se o localStorage for limpo.
        const FALLBACK_USERS = [
            { login: 'paulo', pass: 'master@2026', name: 'Paulo Parreira', role: 'admin', tenant: 'parreira' }
        ];

        document.addEventListener('DOMContentLoaded', function () {
            checkLogin();
            loadVersion();
        });

        function checkLogin() {
            const user = JSON.parse(localStorage.getItem('logged_user') || 'null');
            const tenant = localStorage.getItem('app_tenant_id');

            if (!user || !tenant) {
                document.getElementById('loginOverlay').style.display = 'flex';
                return;
            }

            renderUserInfo(user);
        }

        async function handleLogin(e) {
            e.preventDefault();

            const tenant = document.getElementById('tenantId').value.trim(); // Allow mixed case input, strictly handled below? JS usually case sensitive
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;

            // 1. Validate Tenant
            if (!ALLOWED_TENANTS.includes(tenant)) {
                alert('Empresa n√£o encontrada ou inativa!');
                return;
            }

            // 2. Validate User against Central Registry
            // Logic: Try to find user in storedUsers belonging to this tenant 
            // OR if user is 'admin'/'parreira', they might have multi-tenant access (simplification)

            let validUser = storedUsers.find(u => u.login === user && u.pass === pass && (u.tenant === tenant || u.tenant === 'parreira'));

            // Fallback for initial setup (if registry empty or admin fallback)
            if (!validUser) {
                validUser = FALLBACK_USERS.find(u => u.login === user && u.pass === pass);
                // If fallback, assume supervisor role
                if (validUser) validUser.tenant = tenant;
            }

            if (validUser) {
                // Login Success
                localStorage.setItem('logged_user', JSON.stringify(validUser));
                localStorage.setItem('app_tenant_id', tenant);

                // Show UI
                document.getElementById('loginOverlay').style.display = 'none';
                renderUserInfo(validUser);

                // Redirect if needed (e.g. if we were on a specific module)
                // location.reload(); 
            } else {
                alert('Usu√°rio ou senha incorretos para esta empresa!');
            }
        }

        function renderUserInfo(user) {
            document.getElementById('userName').textContent = user.name || user.login;
            document.getElementById('userRole').textContent = user.role === 'supervisor' || user.role === 'admin' ? 'Supervisor' : 'Operacional';

            // Enable master panel ONLY for admin and parreira tenants or users with role 'admin'
            const isMaster = user.tenant === 'parreira' || user.role === 'admin' || user.login === 'admin';

            const masterCard = document.querySelector('.module-master');
            if (masterCard) {
                if (!isMaster) {
                    masterCard.classList.add('disabled'); // Ensure it's disabled
                    masterCard.style.opacity = '0.5';
                    masterCard.style.pointerEvents = 'none';
                    masterCard.querySelector('.module-status').textContent = 'Restrito';
                    masterCard.querySelector('.module-status').className = 'module-status inactive';
                } else {
                    masterCard.classList.remove('disabled'); // Ensure it's enabled
                    masterCard.style.opacity = '1';
                    masterCard.style.pointerEvents = 'auto';
                    masterCard.querySelector('.module-status').textContent = 'Acesso Total';
                    masterCard.querySelector('.module-status').className = 'module-status active';
                }
            }
        }

        function loadVersion() {
            // Load Platform Core Version
            fetch('version.json')
                .then(r => r.json())
                .then(data => {
                    const badge = document.getElementById('versionBadge');
                    if (badge) badge.textContent = `v${data.version}`;
                    console.log(`üöÄ ${data.name} loaded. Build: ${data.build}`);
                })
                .catch(err => console.warn('Falha ao carregar vers√£o da plataforma', err));
        }

        function openModule(module) {
            const card = document.querySelector(`.module-${module === 'sales-force' ? 'sales' : module}`);
            if (card && card.classList.contains('disabled')) return;

            switch (module) {
                case 'dispatch':
                    window.open('modules/dispatch/index.html', '_blank');
                    break;
                case 'master':
                    window.open('modules/master/index.html', '_blank');
                    break;
                case 'erp':
                    window.open('modules/erp/index.html', '_blank');
                    break;
                case 'wms':
                    window.open('modules/wms/index.html', '_blank');
                    break;
                case 'wms-coletor':
                    window.open('modules/wms-coletor/index.html', '_blank');
                    break;
                case 'sales-force':
                    alert('M√≥dulo em desenvolvimento.');
                    break;
            }
        }

        function logout() {
            localStorage.removeItem('logged_user');
            // localStorage.removeItem('app_tenant_id'); // Optional: keep tenant for convenience
            location.reload();
        }
    </script>
</body>

</html>